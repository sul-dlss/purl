//= require jQuery.XDomainRequest

(function($) {

  $.fn.embedPurl = function(config) {
    var height = parseInt(config.height, 10),
        width = parseInt(config.width, 10),
        $this = $(this),
        serverURL = "<%= Settings.embed_host %>";

    if (!isNaN(width)) $this.width(width);
    if (!isNaN(height)) $this.height(height);

    $.getJSON(serverURL + '/' + config.druid + '/embed-html-json?callback=?')
      .done(function(obj) {
        purlServerURL = obj.purlServerURL;
        peServerURL = obj.purlServerURL;
        peContainerWidth  = $this.width();
        peContainerHeight = $this.height();

        $('head').append('<link rel="stylesheet" href="<%= (Rails.application.config.asset_host || Settings.embed_host) + asset_path('purl_embed.css') %>" type="text/css" />')

        $.getScript('<%= (Rails.application.config.asset_host || Settings.embed_host) + asset_path('purl_embed.js') %>', function() {
          $this.html(obj.page);
          var pe = new purlEmbed(obj.peImgInfo, obj.pePid, obj.peStacksURL, config, $this.selector);
        });
      })
      .fail(function(xhr, status, errorThrown) {
        $this.html("Error loading images for " + config.druid);
      });
  };


})(jQuery);
